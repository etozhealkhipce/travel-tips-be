app:
  name: travel-tips-be
  namespace: sskd
  replicas: 1
  port: 1337
  healthPath: /_health

  image:
    repository: ghcr.io/etozhealkhipce/travel-tips-be
    tag: latest
    pullPolicy: Always

  imagePullSecrets:
    - name: travel-tips-be-ghcr-secret

  initContainers:
    - name: wait-for-db
      image: postgres:16-alpine
      command: ["sh", "-c"]
      args:
        - |
          echo "Waiting for database to be ready..."
          until pg_isready -h "${DATABASE_HOST}" -p "${DATABASE_PORT}" -U "${DATABASE_USERNAME}" 2>/dev/null; do
            echo "Database is unavailable - sleeping"
            sleep 2
          done
          echo "Database is ready! Strapi will handle schema sync automatically."
      env:
        DATABASE_HOST: travel-tips-db
        DATABASE_PORT: "5432"

  env:
    NODE_ENV: production
    HOST: "0.0.0.0"
    PORT: "1337"
    DATABASE_CLIENT: postgres
    DATABASE_HOST: travel-tips-db
    DATABASE_PORT: "5432"
    URL: https://travel-tips.sskd.tech
  envFrom:
    - secretRef:
        name: travel-tips-be-secrets

  resources:
    requests:
      memory: "256Mi"
      cpu: "200m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  # Единый ingress для всего (на стороне backend)
  ingress:
    enabled: true
    host: travel-tips.sskd.tech
    # Основной path указывает на backend, но мы его не используем
    # Все маршруты через extraPaths
    path: /_backend
    extraPaths:
      # Статика админки (самый специфичный)
      - path: /.strapi
        pathType: Prefix
        serviceName: travel-tips-be
        servicePort: 1337
      # API и админка Strapi
      - path: /strapi
        pathType: Prefix
        serviceName: travel-tips-be
        servicePort: 1337
      # Frontend (всё остальное) - должен быть последним!
      - path: /
        pathType: Prefix
        serviceName: travel-tips-frontend
        servicePort: 3000
